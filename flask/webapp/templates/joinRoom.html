<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join</title>
</head>
<body>

    
    <label for="username">Enter name of room to join:</label>
    <textarea name="username" cols="12" rows="1" id="username"></textarea>
    <button onclick="joinroom()">Join room</button>
</br>
    <textarea name="tosendField" cols="10" rows="3" id="sendField"></textarea>
    <button onclick="send()" id="sendButton">Send</button>
</br>
    <textarea name="receiveField" cols="10" rows="3" id="receiveField"></textarea>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <script>

        const usernameid = document.getElementById("username");
        const sendButton = document.getElementById('sendButton');
        const sendField = document.getElementById('sendField');
        const receiveField = document.getElementById('receiveField');
        var socket = io();
        sendButton.disabled = true;
        sendField.disabled = true;
        receiveField.disabled = true;

        const peerConnection = new RTCPeerConnection();
        var dataChannel;
        var json;

        peerConnection.ondatachannel = e => {
            dataChannel = event.channel;
            sendButton.disabled = false;
            sendField.disabled = false;
            receiveField.disabled = false;

            dataChannel.onopen = e=>{
            sendButton.disabled = false;
            sendField.disabled = false;
            receiveField.disabled = false;
            }

            dataChannel.onclose = e=>{
                sendField.value = "";
                sendButton.disabled = true;
                sendField.disabled = true;
                receiveField.value = "";
                receiveField.disabled = true;
            }

            dataChannel.onmessage= e=>{
                receiveField.value = e.data;
            }
        }

        peerConnection.onicecandidate = e=>{
            console.log("New ice candidate found, reprinting SDP" + JSON.stringify(peerConnection.localDescription));
            //document.getElementById("LocalDesc").value = JSON.stringify(peerConnection.localDescription);
            delete json.localDesc;
            json['answer']=peerConnection.localDescription;
            console.log(json)
            socket.emit('answer',JSON.stringify(json));
        }

        function joinroom(){
            socket.emit('join_room',usernameid.value);
        }

        socket.on('remote_desc_join', function(data){
            json = JSON.parse(data);
            peerConnection.setRemoteDescription(JSON.parse(json.localDesc)).then(a=> console.log("Offer set")).then(e=>{
                    peerConnection.createAnswer().then(a=>peerConnection.setLocalDescription(a)
                );
            });
        });

        socket.on('notfound', function(){
            console.log('User not  found')
        });

        peerConnection.addEventListener('connectionstatechange', event => {
            if (peerConnection.connectionState === 'connected') {
                console.log("Connected")
            }
        });

        function send(){
            const msg = sendField.value;
            sendField.value = "";
            dataChannel.send(msg);
        }

        

    </script>
    
</body>
</html>